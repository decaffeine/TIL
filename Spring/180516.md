<h1>180516</h1>
  

- AOP  

transaction, logging, 보안과 같은 여러 모듈에서 공통으로 필요로 하는 기능들을 분리해서
각 모듈에 적용할 수 있다.  
AOP 공통기능과 핵심 로직을 담은 bean 오브젝트를 합쳐서 새로운 파일을 만들게 된다. 
  
- AOP 핵심 개념  

Target : 부가기능을 부여할 대상  
Advice : Target에게 제공할 부가 기능을 담은 모듈  
Joinpoint : Advice가 적용될 수 있는 위치  
Pointcut : advice를 적용할 joint point를 선별하는 작업  
Proxy : Client와 Target 사이에 투명하게 존재하면서 부가기능을 제공하는 오브젝트  
Advisor : Point cut과 advise를 하나씩 갖고 있는 오브젝트  
Aspect : Aspect는 AOP의 기본 모듈, 한 개 또는 그 이상의 포인트컷과 조합으로 만들어지는 조합  
         싱글톤 형태의 오브젝트로 존재함  
Weaving : pointcut으로 지정된 핵심 관심 메소드가 호출될 때, advice에 해당하는 횡단 관심 메소드가 삽입되는 과정         
          (컴파일 시 / 클래스 로딩 시 / 런타임 시)  
          Spring에서는 Runtime Weaving을 지원.  
          
자동 proxy 생성기 : Spring 제공 클래스 (DefaultAdvisorAutoProxyCreator)  
                   이것을 bean으로 등록해서 사용함.  
                   application context가 bean 오브젝트를 생성하는 과정에 bean 후처리기로 참여.  
                   bean으로 등록된 advisor를 이용하여 proxy를 자동으로 생성.  
  
- AOP 구현 방법   
  
1) Spring API를 이용한 AOP   
2) POJO 클래스를 이용한 AOP  
3) AspectJ 5에서 정의한 @Aspect 어노테이션 기반의 AOP  
    
  
- Spring API를 이용한 AOP
Advice 클래스를 작성  
설정 파일에 Pointcut 설정  
설정 파일에 Advice와 Pointcut을 묶어 놓은 Advisor 설정    
설정 파일에 ProxyFactoryBean  클래스를 이용하여 대상 bean 객체에 Advice 적용  
getBean() 메소드로 빈 객체를 가져와 사용  
  
### 프로젝트 : Spring_11  
  
- pom.xml  
aspectjrt, aspect jools, aspectj weaver  
https://mvnrepository.com/artifact/org.aspectj/aspectjrt/1.8.13  
https://mvnrepository.com/artifact/org.aspectj/aspectjtools/1.8.13  
https://mvnrepository.com/artifact/org.aspectj/aspectjweaver/1.8.13  

```xml
<properties>
  	<org.aspectj.version>1.8.13</org.aspectj.version>
</properties>
<dependencies>
  <!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver -->
  <dependency>
      <groupId>org.aspectj</groupId>
      <artifactId>aspectjweaver</artifactId>
      <version>${org.aspectj.version}</version>
  </dependency>
  <!-- https://mvnrepository.com/artifact/org.aspectj/aspectjtools -->
  <dependency>
      <groupId>org.aspectj</groupId>
      <artifactId>aspectjtools</artifactId>
      <version>${org.aspectj.version}</version>
  </dependency>
  <!-- https://mvnrepository.com/artifact/org.aspectj/aspectjrt -->
  <dependency>
      <groupId>org.aspectj</groupId>
      <artifactId>aspectjrt</artifactId>
      <version>${org.aspectj.version}</version>
  </dependency>
</dependencies>
```

- com.sist.proxy.UppercaseAdvice.java  
  
```java
package com.sist.proxy;

import org.aopalliance.intercept.MethodInterceptor;
import org.aopalliance.intercept.MethodInvocation;
import org.apache.log4j.Logger;

public class UppercaseAdvice implements MethodInterceptor {

	Logger log = Logger.getLogger(this.getClass());

	@Override
	public Object invoke(MethodInvocation i) throws Throwable {
		// MethodInterceptor.class의 샘플 코드와 같게

				 log.debug("method "+i.getMethod()+" is called on "+
			                         i.getThis()+" with args "+i.getArguments());
			     
				 String  ret=(String) i.proceed();
			     
				 log.debug("method "+i.getMethod()+" returns "+ret);
			     
				 return ret.toUpperCase();
	
	}

}


```

- maven project 문제 해결  
    
Show View - Problems   

문제 일으킨 라이브러리 폴더 지우기  (파일에서 Ctrl + h 하면 숨김 파일이 나온다)   
  
  
  
- com.sist.comm.TransactionAdvice.java  
  
```java
package com.sist.comm;

import org.apache.log4j.Logger;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.TransactionStatus;
import org.springframework.transaction.support.DefaultTransactionDefinition;

import java.sql.SQLException;

import org.aopalliance.intercept.MethodInterceptor;
import org.aopalliance.intercept.MethodInvocation;
/**
 * Transaction Advice
 * @author sist
 *
 */
public class TransactionAdvice implements MethodInterceptor {
	
	Logger log = Logger.getLogger(this.getClass());
	
	private PlatformTransactionManager transactionManager;

	public void setTransactionManager(PlatformTransactionManager transactionManager) {
		this.transactionManager = transactionManager;
	}

	@Override
	public Object invoke(MethodInvocation invocation) throws Throwable {
       TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

       try {
    	   Object ret = invocation.proceed();
    	   log.debug("****commit*****");
    	   transactionManager.commit(status);
    	   return ret;
       }catch(SQLException e) {
    	   log.debug("****TransactionAdvice*****");
    	   log.debug(e.getMessage());
    	   log.debug("****TransactionAdvice*****");
    	   log.debug("****rollback****");
    	   transactionManager.rollback(status);
    	   
    	   throw e;
       }
		
		
	}

}
  
```  

- com.sist.comm.NameMatchClassMethodPointcut  
  
```java
package com.sist.comm;


import org.apache.log4j.Logger;
import org.springframework.aop.ClassFilter;
import org.springframework.aop.support.NameMatchMethodPointcut;
import org.springframework.util.PatternMatchUtils;

public class NameMatchClassMethodPointcut extends NameMatchMethodPointcut {
	
		static Logger log = Logger.getLogger(NameMatchClassMethodPointcut.class);
	
		//class filter
	   public void setMappedClassName(String mappedName) {
		   this.setClassFilter(new SimpleClassFilter(mappedName));
	   }
	   
	   static class SimpleClassFilter implements ClassFilter {
		   
		   String mappedName;
		   
		   public SimpleClassFilter(String mappedName) {
			   this.mappedName = mappedName;
		   }

		@Override
		public boolean matches(Class<?> clazz) {
			log.debug("^^^^^^^^^^^^^^^^^^^^^^^^^^^^^");
			log.debug("mappedName = " + mappedName);
			log.debug("clazz = " + clazz.getSimpleName());
			log.debug("PatternMatchUtils.simpleMatch=" + PatternMatchUtils.simpleMatch(mappedName, clazz.getSimpleName()));
			log.debug("^^^^^^^^^^^^^^^^^^^^^^^^^^^^^");
			return PatternMatchUtils.simpleMatch(mappedName, clazz.getSimpleName());
		}
		   
		   
	   }

}

```
  
  
- applicationContext.xml  

```xml
<!-- Transaction advice -->		
<bean id = "transactionAdvice" class = "com.sist.comm.TransactionAdvice">
		<property name = "transactionManager" ref = "transactionManager" />
</bean>

<!-- transaction pointcut -->
<bean id = "transactionPointcut" class = "com.sist.comm.NameMatchClassMethodPointcut">
	  <property name = "mappedClassName" value = "*Imple"></property>
	  <property name = "mappedName" value = "upgrade*"></property>
	  
</bean>

<!-- transaction advisor -->
<bean id = "transactionAdvisor" class = "org.springframework.aop.support.DefaultPointcutAdvisor">
	<property name = "advice" ref = "transactionAdvice"> </property>
	<property name = "pointcut" ref = "transactionPointcut"></property>
</bean>

<!--  자동 프록시 생성기 -->
<bean class = "org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"></bean>

<bean id="userServiceImple" class="com.sist.user.service.UserServiceImple">
		<property name="userDao" ref="userDao"/>
	   <property name="transactionManager" ref="transactionManager" />
	</bean>


```
  
  
- Userservice.java  
```java
package com.sist.user.service;

import java.sql.SQLException;

import com.sist.user.domain.User;

public interface UserService {
	/**
	 * 신규사용자에 대한 등급 (Level.BASIC으로 기본값 설정)
	 * @param user
	 * @throws SQLException
	 */
	public void add(User user) throws SQLException;	
	
	//등업처리
	//Level.BASIC, 로그인 >= 50 ===> Level.SILVER
	//Level.SILVER, 추천 >= 30 ===> Level.GOLD
	public void upgradeLevels() throws SQLException;
}
```

- UserServiceImple.java  
 
기존 UserService.java를 UserServiceImple.java로 rename  
upgradeLevels()에서 트랜잭션 관련 코드, try-catch를 삭제 (이제 TransactionAdvice에서 해 줄 거니까)  
  
```java
	public void upgradeLevels() throws SQLException {

		SearchVO searchVO = new SearchVO(10, 1, "hyejin", "10"); // 10:아이디 검색

		List<User> list = userDao.getSelectList(searchVO);
		for (int i = 0; i < list.size(); i++) {
			Boolean changed = false; // 레벨 변화 체크
			User user = list.get(i);

			// 레벨변경이 있는 경우 update 호출
			if (canUpgradeLevel(user) == true) {
				upgradeLevel(user);
			}
			
			//if(i==4) throw new SQLException("내가 만든 excpetion");

		} // --for

	}// --upgradeLevels
```

내가 만든 Exception을 발생시켜 보자. (rollback)  
저 부분이 실행되지 않으면 commit  
  
- (Test) UserServiceTest.java  

다른 test들은 ignore하고 upgradeLevels() 테스트만 실행  
